name: New 2 -- Auto Update Genesys Cloud Tools Manifest

on:
  push:
    branches:
      - '**'
    paths:
      - "genesyscloudtools/modules/**.js"
      - "genesyscloudtools/launcher.js"
      - "genesyscloudtools/helpers.js"
      - ".github/workflows/update-manifest.yml"

  workflow_dispatch:                 # allow manual run from Actions tab

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Generate manifest.json
        run: |
          echo "ğŸ”§ Generating manifest.json ..."
          BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/genesyscloudtools"
          MODULE_DIR="genesyscloudtools/modules"
          MANIFEST_FILE="genesyscloudtools/manifest.json"
          mkdir -p genesyscloudtools

          echo '{' > $MANIFEST_FILE

          # Always include helpers.js first
          echo '  "helpers": [' >> $MANIFEST_FILE
          echo '    "'$BASE_URL'/helpers.js"' >> $MANIFEST_FILE
          echo '  ],' >> $MANIFEST_FILE

          # Add launcher
          echo '  "launcher": "'$BASE_URL'/launcher.js",' >> $MANIFEST_FILE

          # Add modules
          echo '  "modules": [' >> $MANIFEST_FILE
          FIRST=1
          for f in $(ls $MODULE_DIR/*.js 2>/dev/null || true); do
            FILE_URL="$BASE_URL/${f#genesyscloudtools/}"
            if [ $FIRST -eq 0 ]; then echo ',' >> $MANIFEST_FILE; fi
            echo '    "'$FILE_URL'"' >> $MANIFEST_FILE
            FIRST=0
          done
          echo '  ]' >> $MANIFEST_FILE
          echo '}' >> $MANIFEST_FILE

          echo "âœ… Generated manifest.json:"
          cat $MANIFEST_FILE

      - name: ğŸ’¾ Commit and Push manifest.json
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add --force genesyscloudtools/manifest.json
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit. Skipping push."
          else
            git commit -m "ğŸ¤– Auto-update manifest.json [skip ci]"
            git push
            echo "âœ… manifest.json committed and pushed."
          fi
