name: Auto Update Genesys Cloud Tools Manifest

on:
  push:
    branches:
      - main
    paths:
      - "genesyscloudtools/modules/**.js"
      - "genesyscloudtools/launcher.js"

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: 🧱 Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Generate manifest.json
        id: gen
        run: |
          echo "Generating manifest.json ..."
          BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/genesyscloudtools"
          MODULE_DIR="genesyscloudtools/modules"

          # Write header
          echo '{' > genesyscloudtools/manifest.json
          echo '  "launcher": "'$BASE_URL'/launcher.js",' >> genesyscloudtools/manifest.json
          echo '  "modules": [' >> genesyscloudtools/manifest.json

          FIRST=1
          for f in $(ls $MODULE_DIR/*.js 2>/dev/null); do
            FILE_URL="$BASE_URL/${f#genesyscloudtools/}"
            if [ $FIRST -eq 0 ]; then
              echo ',' >> genesyscloudtools/manifest.json
            fi
            echo '    "'$FILE_URL'"' >> genesyscloudtools/manifest.json
            FIRST=0
          done

          echo '  ]' >> genesyscloudtools/manifest.json
          echo '}' >> genesyscloudtools/manifest.json

          echo "Generated manifest.json:"
          cat genesyscloudtools/manifest.json

      - name: 💾 Commit updated manifest
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add genesyscloudtools/manifest.json
          git commit -m "🤖 Auto-update manifest.json" || echo "No changes to commit"
          git push
